<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">

    <!-- Bootstrap CSS link -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons CSS link -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.19.0/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f8f9fa;
            margin: 0;
            padding: 0;
        }

        h1 {
            font-size: 2rem;
            text-align: center;
            margin-top: 30px;
            margin-bottom: 10px;
        }

        .section {
            margin-top: 10px;  /* Decreased line spacing */
            margin-bottom: 10px;  /* Decreased line spacing */
        }

        .card {
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            background-color: #fff;
            padding: 10px;  /* Decreased padding */
        }

        .section .details p {
            font-size: 0.9rem;  /* Smaller font size */
            color: #555;
            margin-bottom: 5px;  /* Decreased line spacing */
        }

        /* Style for images */
        .section img {
            float: left;
            width: 100px;  /* Make it square */
            height: 100px;
            margin-right: 15px; /* Space between image and text */
            border-radius: 10px;
            object-fit: cover; /* Ensure the image doesn't stretch */
        }

        .section .details {
            overflow: hidden; /* Ensure text doesn't overflow when image is floating */
        }

        .protection-info {
            text-align: center;
            font-size: 1rem;
            color: #007bff;
            margin-top: 10px;
        }

        .protection-info i {
            margin-right: 5px;
        }

        @media (max-width: 576px) {
            h1 {
                font-size: 1.6rem;
            }

            .section .details p {
                font-size: 0.8rem;  /* Smaller font size on mobile */
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Display the User Input and Blockchain Protected info -->
        <h1 id="mainHeading"></h1>
        <div class="protection-info">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-bag-check-fill" viewBox="0 0 16 16">
                <path fill-rule="evenodd" d="M10.5 3.5a2.5 2.5 0 0 0-5 0V4h5zm1 0V4H15v10a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V4h3.5v-.5a3.5 3.5 0 1 1 7 0m-.646 5.354a.5.5 0 0 0-.708-.708L7.5 10.793 6.354 9.646a.5.5 0 1 0-.708.708l1.5 1.5a.5.5 0 0 0 .708 0z"/>
              </svg> Blockchain Protected
        </div>

        <!-- Section for displaying Stakeholder details -->
        <div id="supplier" class="section">
            <div class="card">
                <div class="details">
                    <img src="sup_auth.png" alt="Supplier Image"> <!-- Placeholder image -->
                    <div id="supplierDetails"></div>
                </div>
            </div>
        </div>

        <div id="manufacturer" class="section">
            <div class="card">
                <div class="details">
                    <img src="man_auth.png" alt="Manufacturer Image"> <!-- Placeholder image -->
                    <div id="manufacturerDetails"></div>
                </div>
            </div>
        </div>

        <div id="wholesaler" class="section">
            <div class="card">
                <div class="details">
                    <img src="wh_auth.png" alt="Wholesaler Image"> <!-- Placeholder image -->
                    <div id="wholesalerDetails"></div>
                </div>
            </div>
        </div>

        <div id="retailer" class="section">
            <div class="card">
                <div class="details">
                    <img src="rt_auth.png" alt="Retailer Image"> <!-- Placeholder image -->
                    <div id="retailerDetails"></div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/web3@1.6.1/dist/web3.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let s = '';
        let m = '';
        // This function will run when the page loads
        window.onload = async function() {
            const st = performance.now();
            // 1. Extract the userInput parameter from the URL
            const urlParams = new URLSearchParams(window.location.search);
            const userInput = urlParams.get('userInput');
            
            if (userInput) {
                // Set the heading text to the userInput value
                document.getElementById("mainHeading").textContent = `${userInput}`;
                
                try {
                    
                    // 2. Fetch the data from /getString with the userInput
                    const response = await fetch(`/getString?userInput=${userInput}`);
                    
                    if (!response.ok) {
                        throw new Error('Failed to fetch data from /getString');
                    }

                    // 3. Parse the response as a comma-separated string
                    const data = await response.text();
                    const parsedData = data.split(',');

                    // 4. Extract values for each stakeholder from the parsed data
                    const supplierId = parsedData[0];
                    s = parsedData[1];
                    const manufacturerId = parsedData[2];
                    m = parsedData[3];
                    const wholesalerId = parsedData[4];
                    const retailerId = parsedData[5];

                    // 5. Fetch details for each stakeholder using the ids
                    await fetchStakeholderDetails(supplierId, 'suppliers', 'supplierDetails');
                    await fetchStakeholderDetails(manufacturerId, 'manufacturer', 'manufacturerDetails');
                    await fetchStakeholderDetails(wholesalerId, 'wholesaler', 'wholesalerDetails');
                    await fetchStakeholderDetails(retailerId, 'retailer', 'retailerDetails');
                 
                } catch (error) {
                    console.error('Error:', error);
                }
            } else {
                console.error('User input parameter is missing in the URL');
            }
            const et = performance.now();
            const executionTime = et - st;
            console.log(executionTime);
        }

        // Function to fetch stakeholder details based on the id and type
        async function fetchStakeholderDetails(id, type, sectionId) {
            try {
                const response = await fetch(`/view?userInput=${id},${type}`);
                console.log(type);
                
                if (!response.ok) {
                    throw new Error(`Failed to fetch details for ${type}`);
                }

                const data = await response.json();

                if (data && data.data && data.data.length > 0) {
                    let htmlContent = '';
                    if (type === 'suppliers') {
                        htmlContent = `
                            <p><strong> Supplier ID:</strong> ${data.data[0].id} <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-bag-check-fill" viewBox="0 0 16 16">
  <path fill-rule="evenodd" d="M10.5 3.5a2.5 2.5 0 0 0-5 0V4h5zm1 0V4H15v10a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V4h3.5v-.5a3.5 3.5 0 1 1 7 0m-.646 5.354a.5.5 0 0 0-.708-.708L7.5 10.793 6.354 9.646a.5.5 0 1 0-.708.708l1.5 1.5a.5.5 0 0 0 .708 0z"/>
</svg></p>
                            <p><strong>Name:</strong> ${data.data[0].name}</p>
                            <p><strong>License:</strong> ${data.data[0].license}</p>
                            <p><strong>Supplied :</strong> ${formatTimestamp(s)} <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-bag-check-fill" viewBox="0 0 16 16">
  <path fill-rule="evenodd" d="M10.5 3.5a2.5 2.5 0 0 0-5 0V4h5zm1 0V4H15v10a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V4h3.5v-.5a3.5 3.5 0 1 1 7 0m-.646 5.354a.5.5 0 0 0-.708-.708L7.5 10.793 6.354 9.646a.5.5 0 1 0-.708.708l1.5 1.5a.5.5 0 0 0 .708 0z"/>
</svg></p>
                        `;
                    } else if (type === 'manufacturer') {
                        htmlContent = `
                            <p><strong>Manufacturer ID:</strong> ${data.data[0].id} <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-bag-check-fill" viewBox="0 0 16 16">
  <path fill-rule="evenodd" d="M10.5 3.5a2.5 2.5 0 0 0-5 0V4h5zm1 0V4H15v10a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V4h3.5v-.5a3.5 3.5 0 1 1 7 0m-.646 5.354a.5.5 0 0 0-.708-.708L7.5 10.793 6.354 9.646a.5.5 0 1 0-.708.708l1.5 1.5a.5.5 0 0 0 .708 0z"/>
</svg></p>
                            <p><strong>Name:</strong> ${data.data[0].manuf_factory}</p>
                            <p><strong>Address:</strong> ${data.data[0].manuf_addr}</p>
                            <p><strong>Manufactured :</strong> ${formatTimestamp(m)} <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-bag-check-fill" viewBox="0 0 16 16">
  <path fill-rule="evenodd" d="M10.5 3.5a2.5 2.5 0 0 0-5 0V4h5zm1 0V4H15v10a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V4h3.5v-.5a3.5 3.5 0 1 1 7 0m-.646 5.354a.5.5 0 0 0-.708-.708L7.5 10.793 6.354 9.646a.5.5 0 1 0-.708.708l1.5 1.5a.5.5 0 0 0 .708 0z"/>
</svg></p>
                        `;
                    } else if (type === 'wholesaler') {
                        htmlContent = `
                            <p><strong>Wholesaler ID:</strong> ${data.data[0].id} <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-bag-check-fill" viewBox="0 0 16 16">
  <path fill-rule="evenodd" d="M10.5 3.5a2.5 2.5 0 0 0-5 0V4h5zm1 0V4H15v10a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V4h3.5v-.5a3.5 3.5 0 1 1 7 0m-.646 5.354a.5.5 0 0 0-.708-.708L7.5 10.793 6.354 9.646a.5.5 0 1 0-.708.708l1.5 1.5a.5.5 0 0 0 .708 0z"/>
</svg></p>
                            <p><strong>Name:</strong> ${data.data[0].name}</p>
                            <p><strong>License:</strong> ${data.data[0].trade_license}</p>
                            <p><strong>Expiry Date:</strong> ${data.data[0].expiry}</p>
                        `;
                    } else if (type === 'retailer') {
                        htmlContent = `
                            <p><strong>Retailer ID:</strong> ${data.data[0].id} <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-bag-check-fill" viewBox="0 0 16 16">
  <path fill-rule="evenodd" d="M10.5 3.5a2.5 2.5 0 0 0-5 0V4h5zm1 0V4H15v10a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V4h3.5v-.5a3.5 3.5 0 1 1 7 0m-.646 5.354a.5.5 0 0 0-.708-.708L7.5 10.793 6.354 9.646a.5.5 0 1 0-.708.708l1.5 1.5a.5.5 0 0 0 .708 0z"/>
</svg></p>
                            <p><strong>Name:</strong> ${data.data[0].name}</p>
                            <p><strong>License:</strong> ${data.data[0].trade_license}</p>
                            <p><strong>Expiry Date:</strong> ${data.data[0].expiry}</p>
                        `;
                    }

                    // Display the details in the corresponding section
                    document.getElementById(sectionId).innerHTML = htmlContent;
                } else {
                    document.getElementById(sectionId).innerHTML = `<p>No data available for ${type}</p>`;
                }
            } catch (error) {
                console.error(`Error fetching ${type} details:`, error);
                document.getElementById(sectionId).innerHTML = `<p>Error fetching data for ${type}</p>`;
            }
        }

        function formatTimestamp(timestamp) {
            const date = new Date(timestamp * 1000); // Convert UNIX timestamp to milliseconds
            return date.toLocaleString(); // Format date and time
        }
    </script>
</body>
</html>
